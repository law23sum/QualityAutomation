/***
 This `build.gradle` file is organized into the following sections:

 1. Plugins: Define the plugins required for the project.
 2. Basic project information: Set the project's group, version, and description.
 3. Java source and target compatibility: Configure the Java version.
 4. IDEA project configuration: Configure the IntelliJ IDEA project settings.
 5. Repositories: Define the repositories for fetching dependencies.
 6. External dependency versions: Set the versions for external dependencies.
 7. Dependencies: Define the project dependencies.
 8. Source sets configuration: Configure the source sets for the project.
 9. Maven publishing configuration: Configure the Maven publishing settings.
 10. Compiler options: Set the Java compiler options.
 11. Test execution configuration: Configure
 */

// Section 1: Plugins
plugins {
//   id 'net.serenity-bdd.aggregator' version '3.5.0'
   id 'net.serenity-bdd.serenity-gradle-plugin' version '3.5.0'
   id 'java'
   id 'org.gradle.java-library'
   id 'groovy'
   id 'idea'
   id 'eclipse'
   id 'java-test-fixtures'
   id 'maven-publish'  // handle publishing artifacts to Maven repo
   // Experimenting with plugins
   id 'com.jfrog.bintray' version '1.8.5'
   id 'com.intershop.gradle.jiraconnector' version '6.3.0'
}

group = 'com.company'
version = '1.0-SNAPSHOT'
description = 'Quality Automation'

import org.gradle.process.internal.ExecException
import au.com.bytecode.opencsv.CSVReader

// Section 3: Java source and target compatibility
sourceCompatibility = JavaVersion.toVersion(properties['javaVersion'])
targetCompatibility = JavaVersion.toVersion(properties['javaVersion'])

jar {
   archiveBaseName = 'QualityAutomation'
   archiveVersion =  '0.0.1'
}

// Section 4: IDEA project configuration
idea {
   module {
      downloadJavadoc = true
      downloadSources = true
   }
}

// Section 5: Repositories
repositories {
   mavenCentral()
   google()
}

configurations {
   cucumberRuntime {
      extendsFrom testImplementation
   }
}

configurations {
   runtimeClasspath {
      extendsFrom testImplementation
   }
}

def loadProjectProperties() {
   def properties = new Properties()
   def propertiesFile = file('project.properties')
   if (propertiesFile.exists()) {
      properties.load(propertiesFile.newDataInputStream())
   }
   return properties
}

def projectProperties = loadProjectProperties()

// Load Serenity properties
Properties serenityProperties = new Properties()
file("serenity.properties").withInputStream { serenityProperties.load(it) }

// Load Cucumber properties
Properties cucumberProperties = new Properties()
file("cucumber.properties").withInputStream { cucumberProperties.load(it) }

// Section 6: External dependency versions
ext {
   junitVersion = '5.9.2'
   cucumberJavaVersion = '7.11.2'
   cucumberJUnitPlatformEngineVersion = '7.11.2'
   serenityVersion = '3.6.7'
   serenityCoreVersion = '3.3.6'
   serenityJUnit5Version = '3.6.12+'
   serenityCucumberVersion = '3.6.22'
   groovyMavenPluginVersion = '1.5'
   slf4jApiVersion = '2.0.7'
   restAssuredVersion = '5.3.0'
   seleniumVersion = '4.8.1'
}

// Section 7: Dependencies
dependencies {
   // JUnit 4 for backward compatible + JUnit 5
   testImplementation 'junit:junit:4.13.1'
   testImplementation "org.junit.jupiter:junit-jupiter-api:${junitVersion}"
   testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:${junitVersion}"
   testImplementation "io.cucumber:cucumber-java:${cucumberJavaVersion}"
   testImplementation "io.cucumber:cucumber-junit-platform-engine:${cucumberJUnitPlatformEngineVersion}"

   // Serenity and Cucumber integration for testing
   testImplementation "org.slf4j:slf4j-simple:1.7.30"
   implementation "net.serenity-bdd:serenity-core:${serenityCoreVersion}"
   testImplementation "net.serenity-bdd:serenity-cucumber:${serenityCucumberVersion}"
   implementation "net.serenity-bdd:serenity-cli:${serenityVersion}"
   implementation("net.serenity-bdd:serenity-junit5:${serenityJUnit5Version}") {
      exclude group: 'org.seleniumhq.selenium', module: 'selenium-java'
   }

   // REST Assured
   testImplementation "io.rest-assured:spring-web-test-client:${restAssuredVersion}"

   // For using WinAppDriver
   // Appium Java client
   implementation 'io.appium:java-client:8.3.0'

   // Selenium WebDriver
   testImplementation "org.seleniumhq.selenium:selenium-java:${seleniumVersion}"
   // Groovy
   implementation "org.codehaus.mojo:groovy-maven-plugin:${groovyMavenPluginVersion}"
   implementation 'org.codehaus.groovy:groovy-all:2.4.15'

   // Test dependencies
   testImplementation "org.junit.jupiter:junit-jupiter-api:${junitVersion}"

   // Experiment=
   testImplementation 'org.hamcrest:hamcrest:2.2'
   testImplementation 'app.getxray:xray-junit-extensions:0.6.1'
   implementation 'com.opencsv:opencsv:5.7.0'
}



// Section 8: Source sets configuration
sourceSets {
   main {
      java {
         srcDir 'src/main/java'
      }
      resources {
         srcDirs = ['src/main/resources', 'src/main/groovy-resources']
      }
   }
   test {
      java {
         srcDir 'src/test/java'
      }
      resources {
         srcDirs = ['src/test/resources', 'src/test/groovy-resources']
      }
   }
}

// Section 9: Maven publishing configuration
publishing {
   publications {
      mavenJava(MavenPublication) {
         from components.java
      }
   }
}

// Section 10: Compiler options
tasks.withType(JavaCompile).configureEach {
   options.encoding = 'UTF-8'
   options.compilerArgs << '-Xlint:unchecked' << '-Xlint:deprecation'
}

tasks.withType(GroovyCompile).configureEach {
   groovyOptions.encoding = 'UTF-8'
}

def envProperties = new Properties()
file("env.properties").withInputStream { envProperties.load(it) }


// Section 11: Test execution configuration
test {
   // Use JUnit Platform for running tests
   useJUnitPlatform()

   // Set default value for selected environment
   def selectedEnv = project.findProperty('selectedEnv') ?: 'default'

   // Load environment-specific properties
   envProperties.entrySet().each { entry ->
      if (entry.key.startsWith("$selectedEnv.")) {
         systemProperty entry.key - "$selectedEnv.", entry.value
      }
   }

   // Set system properties
   systemProperties System.getProperties()

   // Set Serenity properties
   serenityProperties.each { key, value ->
      systemProperty key, value
   }

   // Set Cucumber properties
   cucumberProperties.each { key, value ->
      systemProperty key, value
   }

   // Set WebDriver properties
   systemProperty "webdriver.base.url", project.findProperty("webdriver.base.url") ?: "http://localhost:8080"

   // Configure test logging
   testLogging.showStandardStreams = true
   testLogging {
      events 'passed', 'skipped', 'failed'
   }

   // Set test class directories and classpath
   testClassesDirs = sourceSets.test.output.classesDirs
   classpath = sourceSets.test.runtimeClasspath

   // Experimentation
}

gradle.startParameter.continueOnFailure = true

defaultTasks 'dependencies', 'clean', 'test', 'list'

tasks {
   // Compile and package the application code
   assemble {
      // ...
   }

// Run the Serenity CLI task
   serenity {
      dependsOn assemble, compileGroovy, compileJava
      doFirst {
         javaexec {
            main = "net.serenitybdd.cucumber.cli.Main"
            classpath = configurations.cucumberRuntime + sourceSets.main.output + sourceSets.test.output
            args = ['--plugin', 'pretty',
                    '--glue', project.findProperty('cucumber.glue') ?: 'com.company.steps',
                    project.findProperty('cucumber.features') ?: 'src/test/resources']
         }
      }
      doLast {
         javaexec {
            main = 'net.serenitybdd.cli.SerenityCLI'
            classpath = configurations.runtimeClasspath + sourceSets.main.output + sourceSets.test.output
            args = ['aggregate']
            systemProperty "serenity.test.root", project.findProperty("serenity.test.root") ?: "src/test/resources" // Update the path if necessary
            systemProperty "serenity.requirements.directory", project.findProperty("serenity.requirements.directory") ?: "src/test/resources/features" // Update the path if necessary

         }
      }
   }
}

configurations.configureEach {
   resolutionStrategy.cacheChangingModulesFor 0, 'seconds'
   resolutionStrategy.cacheDynamicVersionsFor 0, 'seconds'
   resolutionStrategy.eachDependency { DependencyResolveDetails details ->
      if (details.requested.group == 'org.codehaus.groovy' && details.requested.name == 'groovy') {
         details.useVersion '3.0.16'
      }
   }
}

tasks.register('deleteBuilds') {
   doLast {
      delete 'build'
      delete '.gradle'
      delete 'target'
      // delete 'lib'
   }
}

tasks.register('printEnvVariables') {
   doLast {
      exec {
         commandLine 'printenv'
      }
   }
}

tasks.register('verifyEnvironment') {
   doLast {
      try {
         exec {
            commandLine 'java', '--version'
            ignoreExitValue true
            commandLine 'groovy', '--version'
            ignoreExitValue true
            commandLine 'mvn', '--version'
            ignoreExitValue true
            commandLine 'gradle', '--version'
            ignoreExitValue true
         }
      } catch (ExecException e) {
         println "One or more commands are not installed: ${e.message}"
      }
   }
}
tasks.register('list') {
   doLast {
      gradleTasks()
      genericTasks()
   }
}

tasks.register('importJUnitResultsToXrayDC', Exec) {
   def url = "${project.property('jiraBaseUrl')}/rest/raven/2.0/import/execution/${project.property('reportFormat')}?"
   commandLine 'curl', '--fail-with-body', '-H', 'Content-Type: multipart/form-data', '-u', "${project.property('jiraUsername')}:${project.property('jiraPassword')}", '-F', "file=@${reportFile}", url
}


// Define jiraConnector extension
ext.jiraConnector = [
        qualityAutomation: "Your JIRA Connector Configuration"
]

def gradleTasks() {
   println "\nGradle Custom Tasks"
   println "\tInitial : gradle --full-stacktrace; alias gradlew=\"./gradlew\""
   println "\tDisplay List Custom Tasks : gradlew list"
   println "\tCompile Java & Groovy : gradlew compileJava; gradlew compileGroovy"
}

def genericTasks() {
   println "\nGeneral Custom Tasks"
   println "\tDisplay Local Environments   : gradlew printEnvVariables"
   println "\tDisplay Current Versions     : gradlew printSetupVersions"
   println "\tUpgrade Gradle Version       : gradlew --gradle-version <_._>"
   println "\tDisplay Remove Build Folders : gradlew deleteBuilds"
   println "\tDisplay Gradle Default Tasks : gradlew task"
   println "\tExecute Test Suites          : gradlew test"
   println "\tDebug Argument Options       : gradlew --info|--debug|--full-stacktrace"
   println "\tDebug Dependency Reports     : gradlew dependencyInsight --dependency <org.company.package:dependency>"
   println "\tExecute Test Suites          : gradlew test"
   println "\tDebug :                      : --info --debug --full-stacktrace"
}