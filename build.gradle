import org.gradle.process.internal.ExecException
plugins {
    id 'java'
    id 'groovy'
    id 'idea'
    id 'eclipse'
    id 'java-test-fixtures'
    id 'maven-publish'  // Add the maven-publish plugin to handle publishing artifacts to a Maven repository
}

group   = 'com.company'
version = '1.0-SNAPSHOT'

sourceCompatibility = 17
targetCompatibility = 17

configurations {
    cucumberRuntime {
        extendsFrom testImplementation
    }
}

repositories {
    mavenCentral()
}

ext {
    junitVersion = '5.8.2'
    cucumberJavaVersion = '7.11.2'
    cucumberJUnitPlatformEngineVersion = '7.11.2'
    serenityCoreVersion = '3.3.6'
    serenityJUnit5Version = '3.3.6'
    serenityCucumberVersion = '3.6.22'
    groovyMavenPluginVersion = '1.5'
}

dependencies {
    testImplementation "org.junit.jupiter:junit-jupiter-api:${junitVersion}"
    testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:${junitVersion}"
    testImplementation "io.cucumber:cucumber-java:${cucumberJavaVersion}"
    testImplementation "io.cucumber:cucumber-junit-platform-engine:${cucumberJUnitPlatformEngineVersion}"
    implementation "net.serenity-bdd:serenity-core:${serenityCoreVersion}"
    implementation "net.serenity-bdd:serenity-junit5:${serenityJUnit5Version}"
    implementation "net.serenity-bdd:serenity-cucumber:${serenityCucumberVersion}"
    implementation "org.codehaus.mojo:groovy-maven-plugin:${groovyMavenPluginVersion}"

    // Other dependencies (commented out)
    /*
    // Selenium WebDriver - Browser automation framework
    implementation 'org.seleniumhq.selenium:selenium-java:4.8.1'

    // Appium - Mobile automation framework
    testImplementation 'io.appium:java-client:7.3.0'

    // Log4j - Logging framework
    implementation 'org.apache.logging.log4j:log4j-api:2.13.1'
    implementation 'org.apache.logging.log4j:log4j-core:2.13.1'
    implementation 'org.apache.logging.log4j:log4j-slf4j18-impl:2.13.1'
    */
}

test {
    useJUnitPlatform()
    systemProperty("cucumber.junit-platform.naming-strategy", "long")
    systemProperty "cucumber.features", project.findProperty("cucumber.features") ?: "src/test/resources/features"
    systemProperty "cucumber.filter.tags", project.findProperty("cucumber.tags") ?: ""
    systemProperty "webdriver.base.url", project.findProperty("webdriver.base.url") ?: "http://localhost:8080"
    testClassesDirs = sourceSets.test.output.classesDirs
    classpath = sourceSets.test.runtimeClasspath
    include 'com/company/runner/WebAppRunner.class'
    testLogging {
        events 'passed', 'skipped', 'failed'
    }
}

compileJava {
    options.compilerArgs << "-Xlint:unchecked" << "-Xlint:deprecation"
}

defaultTasks 'dependencies', 'clean', 'build', 'compileJava', 'listTasks'

tasks.withType(Test).configureEach {

}

tasks.register('cucumber') {
    dependsOn testClasses
    doLast {
        javaexec {
            main = "io.cucumber.core.cli.Main"
            classpath = configurations.cucumberRuntime + sourceSets.main.output + sourceSets.test.output
            args = ['--glue', 'com.example.stepdefinitions', '--plugin', 'pretty', '--plugin', 'json:build/reports/cucumber/cucumber.json', 'src/test/resources/features']
        }
    }
}

tasks.register('deleteBuilds') {
    doLast {
        delete 'build'
        delete '.gradle'
        delete 'lib'
        delete 'target'
    }
}
tasks.register('printEnvVariables') {
    doLast {
        exec {
            commandLine 'printenv'
        }
    }
}

tasks.register('printSetupVersions') {
    doLast {
        try {
            exec {
                commandLine 'java', '--version'
                ignoreExitValue true
                commandLine 'groovy', '--version'
                ignoreExitValue true
                commandLine 'mvn', '--version'
                ignoreExitValue true
                commandLine 'gradle', '--version'
                ignoreExitValue true
            }
        } catch (ExecException e) {
            println "One or more commands are not installed: ${e.message}"
        }
    }
}

tasks.register('listTasks') {
    doLast {
        gradleTasks()
        genericTasks()
    }
}

def gradleTasks() {
    println "\nGradle Custom Tasks"
    println "\tInitial : gradle --full-stacktrace; alias gradlew=\"./gradlew\""
    println "\tDisplay List Custom Tasks : gradlew list"
    println "\tCompile Java : gradlew compileJava"
}

def genericTasks() {
    println "\nGeneral Custom Tasks"
    println "\tDisplay Local Environments : gradlew printEnvVariables"
    println "\tDisplay Current Versions : gradlew printSetupVersions"
    println "\tDisplay Remove Build Folders : gradlew deleteBuilds"
    println "\tExecute Test Suites : gradlew test"
    println "\tDebug :  --info --debug --full-stacktrace"
}